name: Smoke Test

# This workflow runs a lightweight smoke runner on push/PR. It avoids
# using GitHub expression secrets in step metadata so editors don't flag
# invalid named-values. Integration tests (which require SUPABASE env vars)
# are run only when those env vars are present at runtime.

on:
  pull_request:
  push:
    branches: [main]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Install
        run: npm ci
      - name: Run smoke (no emails)
        env:
          DISABLE_EMAIL: "true"
        run: |
          npm run smoke &
          SMOKE_PID=$!

          # Poll /ping up to ~10s to reduce flakiness (better than a fixed sleep)
          attempts=0
          until curl --fail --silent http://localhost:3000/ping >/dev/null 2>&1 || [ $attempts -ge 10 ]; do
            attempts=$((attempts+1))
            sleep 1
          done

          if ! curl --fail --silent http://localhost:3000/ping >/dev/null 2>&1; then
            echo "smoke server didn't start in time - printing log" >&2
            cat /tmp/va-smoke.log || true
            kill "$SMOKE_PID" || true
            exit 1
          fi

          # Stop the background smoke runner
          kill "$SMOKE_PID" || true

      - name: Run integration tests (if SUPABASE env provided)
        # Avoid referencing GitHub `secrets` in YAML so editors won't complain;
        # instead check at runtime for environment variables injected into the runner.
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "SUPABASE_URL or SUPABASE_KEY not set — skipping integration tests"
          else
            npm run test:integration
          fi
name: Smoke Test

# Note: workflow uses a runtime shell check to guard running tests when
# SUPABASE_URL / SUPABASE_KEY are not present. This avoids schema/linter
# warnings about referencing `secrets` in YAML expressions.

on:
  pull_request:
  push:
    branches: [main]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Install
        run: npm ci
      - name: Run smoke (no emails)
        env:
          DISABLE_EMAIL: "true"
        run: |
          npm run smoke &
          SMOKE_PID=$!
          sleep 3
          curl --fail --silent http://localhost:3000/ping || (cat /tmp/va-smoke.log || true)
          kill "$SMOKE_PID" || true
      - name: Run integration tests (if Supabase secrets available)
        # Run integration tests only when Supabase secrets are provided in the runner
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "SUPABASE_URL or SUPABASE_KEY not set — skipping integration tests"
            # Start the smoke runner in background; it should bind to :3000
            # Poll for /ping up to ~10s before giving up to reduce flakiness
            attempts=0
            until curl --fail --silent http://localhost:3000/ping >/dev/null 2>&1 || [ $attempts -ge 10 ]; do
              attempts=$((attempts+1))
              sleep 1
            done

            if ! curl --fail --silent http://localhost:3000/ping >/dev/null 2>&1; then
              echo "smoke server didn't start in time - printing log" >&2
              cat /tmp/va-smoke.log || true
              kill "$SMOKE_PID" || true
              exit 1
            fi

            # success - stop the background process
            kill "$SMOKE_PID" || true
